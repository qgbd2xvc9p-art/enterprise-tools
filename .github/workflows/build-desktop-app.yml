name: build-desktop-app

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (leave empty to auto-generate)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: |
          cd app
          flutter pub get

      - name: Build (Windows Release)
        run: |
          cd app
          flutter build windows --release

      - name: Package
        shell: pwsh
        run: |
          $src1 = "app\\build\\windows\\x64\\runner\\Release"
          $src2 = "app\\build\\windows\\runner\\Release"
          if (Test-Path $src1) { $src = $src1 } elseif (Test-Path $src2) { $src = $src2 } else { throw "Release folder not found" }
          $out = "enterprise_tools_app-windows.zip"
          if (Test-Path $out) { Remove-Item $out }
          Compress-Archive -Path "$src\\*" -DestinationPath $out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: enterprise_tools_app-windows
          path: enterprise_tools_app-windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Install dependencies
        run: |
          cd app
          flutter pub get

      - name: Build (macOS Release)
        run: |
          cd app
          flutter build macos --release

      - name: Package
        run: |
          APP_PATH="app/build/macos/Build/Products/Release/enterprise_tools_app.app"
          OUT_PATH="app/build/macos/enterprise_tools_app-macos.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$OUT_PATH"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: enterprise_tools_app-macos
          path: app/build/macos/enterprise_tools_app-macos.zip

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Compute tag
        id: meta
        run: |
          TAG="${{ inputs.release_tag }}"
          if [ -z "$TAG" ]; then TAG="v${{ github.run_number }}"; fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          files: dist/**/enterprise_tools_app-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
